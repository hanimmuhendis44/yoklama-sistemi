<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Iƒüdƒ±r √úniversitesi - Yoklama Sistemi</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script src="https://unpkg.com/html5-qrcode"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>

<style>
    /* --- TASARIM: Temiz, Modern ve Mobil Uyumlu --- */
    body{font-family:'Segoe UI',sans-serif;background:#f0f2f5;display:flex;justify-content:center;align-items:center;min-height:100vh;margin:0}
    
    .card{background:#fff;padding:2rem;border-radius:15px;width:380px;max-width:95%;box-shadow:0 10px 25px rgba(0,0,0,.1);display:none;text-align:center;animation:fadeIn 0.4s}
    @keyframes fadeIn {from{opacity:0;transform:translateY(-10px)} to{opacity:1;transform:translateY(0)}}
    
    #login-screen{display:block}
    
    h2{color:#333;margin-bottom:15px}
    
    button,input,select{width:100%;padding:12px;margin:6px 0;border:1px solid #ddd;border-radius:5px;box-sizing:border-box;font-size:14px}
    button{cursor:pointer;font-weight:bold;transition:0.3s}
    
    .btn-primary{background:#0d6efd;color:#fff;border:none} .btn-primary:hover{background:#0b5ed7}
    .btn-secondary{background:#fff;color:#0d6efd;border:1px solid #0d6efd} .btn-secondary:hover{background:#f0f8ff}
    .btn-danger{background:#dc3545;color:#fff;border:none}
    
    table{width:100%;border-collapse:collapse;font-size:12px;margin-top:10px}
    th,td{border:1px solid #ddd;padding:6px;text-align:center} th{background:#f8f9fa}
    .var{color:green;font-weight:bold;cursor:pointer} .yok{color:red;font-weight:bold;cursor:pointer}
    
    .upload-box{border:2px dashed #0d6efd;padding:15px;margin:10px 0;background:#f8f9fa;cursor:pointer;color:#555;font-size:0.9em}
    .manual-box{border-top:1px solid #eee;padding-top:10px;margin-top:10px}
    
    @media(max-width:600px){.card{padding:1.5rem} button,input{padding:15px;font-size:16px}}
</style>
</head>

<body>

    <div id="login-screen" class="card">
        <h2>Sistem Giri≈üi</h2>
        <p style="color:#666;font-size:0.9em">Iƒüdƒ±r √úniversitesi Yoklama</p>
        
        <input id="login-no" placeholder="Okul No veya 'admin'">
        <input id="login-password" type="password" placeholder="No'nun Son 6 Hanesi">
        
        <button class="btn-primary" onclick="girisYap()">Giri≈ü Yap</button>
        <p id="login-error" style="color:red;display:none;margin-top:5px">Hatalƒ± bilgi!</p>
    </div>

    <div id="course-select-screen" class="card">
        <h2 id="admin-welcome" style="color:#0d6efd"></h2>
        <select id="ders-secimi"></select>
        <button class="btn-primary" onclick="dersiYonet()">Se√ßili Dersi Y√∂net</button>
        <div style="display:flex;gap:5px;margin-top:10px;border-top:1px solid #eee;padding-top:10px">
            <input id="yeni-ders" placeholder="Yeni Ders Ekle" style="margin:0">
            <button class="btn-secondary" onclick="yeniDersEkle()" style="margin:0;width:auto">+</button>
        </div>
        <button class="btn-danger" onclick="cikisYap()">√áƒ±kƒ±≈ü</button>
    </div>

    <div id="teacher-panel" class="card">
        <h2 id="panel-baslik" style="color:#0d6efd"></h2>
        
        <div class="upload-box" onclick="document.getElementById('pdf-input').click()">
            üìÑ PDF Listesi Y√ºkle
            <input type="file" id="pdf-input" accept="application/pdf" style="display:none" onchange="pdfYukle(this)">
        </div>
        <div id="pdf-status" style="font-size:0.8em;color:green;margin-bottom:5px"></div>

        <div class="manual-box">
            <div style="display:flex;gap:5px">
                <input id="man-name" placeholder="Ad Soyad" style="margin:0">
                <input id="man-no" type="number" placeholder="No" style="margin:0;width:80px">
            </div>
            <button class="btn-secondary" onclick="manuelEkle()" style="font-size:12px;padding:5px;width:100%">Manuel Ekle</button>
        </div>

        <button class="btn-secondary" onclick="gecmisiGoster()">üìã Liste / Ge√ßmi≈ü</button>
        <button class="btn-primary" onclick="qrBaslat()" style="background:#198754">YOKLAMA BA≈ûLAT (5 Dk)</button>
        <button class="btn-danger" onclick="ekranDegistir('course-select-screen')">Geri</button>
    </div>

    <div id="qr-screen" class="card">
        <h2 style="color:red;font-weight:800">YOKLAMA VAKTƒ∞</h2>
        <div id="qrcode" style="margin:10px auto;display:flex;justify-content:center"></div>
        <div id="countdown" style="font-size:1.5em;color:#d63384;font-weight:bold;margin-top:10px">05:00</div>
        <p style="font-size:0.8em;color:#666">Kod g√ºvenlik i√ßin 3 saniyede bir yenilenir</p>
        <button class="btn-danger" onclick="yoklamayiBitir()">Bitir</button>
    </div>

    <div id="student-screen" class="card">
        <h2 id="student-welcome"></h2>
        <p>L√ºtfen QR Kodu Okutun</p>
        <div id="reader" style="width:100%"></div>
        <div id="result-area" style="margin-top:10px;font-weight:bold;color:#198754"></div>
        <button id="btn-camera" class="btn-primary" onclick="kamerayiAc()">Kamerayƒ± A√ß</button>
        <button class="btn-danger" onclick="cikisYap()">√áƒ±kƒ±≈ü</button>
    </div>

    <div id="history-screen" class="card" style="width:600px">
        <h2>Yoklama Durumu</h2>
        <div style="overflow-x:auto"><table id="history-table"></table></div>
        <button class="btn-secondary" onclick="ekranDegistir('teacher-panel')">Geri</button>
    </div>

<script>
    // PDF.js Ayarƒ±
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';

    let secilenDers="", qrcodeObj, qrInterval, timerInterval, scanner;
    let yoklamaBitis=0;
    
    // DB Ba≈ülatma (Hafƒ±za Yoksa Olu≈ütur)
    if(!localStorage.getItem("studentsDB")) localStorage.setItem("studentsDB","[]");
    if(!localStorage.getItem("attendanceDB")) localStorage.setItem("attendanceDB","{}");
    if(!localStorage.getItem("coursesDB")) localStorage.setItem("coursesDB",JSON.stringify(["Matematik","Fizik","Algoritma"]));

    // --- EKRAN DEƒûƒ∞≈ûTƒ∞RME ---
    function ekranDegistir(id){
        document.querySelectorAll(".card").forEach(c=>c.style.display="none");
        document.getElementById(id).style.display="block";
        // Kamera temizliƒüi
        if(scanner){scanner.clear().catch(e=>{}); document.getElementById("reader").style.display="none"; document.getElementById("btn-camera").style.display="block";}
        document.getElementById("login-error").style.display="none";
    }

    // --- Gƒ∞Rƒ∞≈û ---
    function girisYap(){
        const u=document.getElementById("login-no").value;
        const p=document.getElementById("login-password").value;
        
        if(u==="admin" && p==="1234"){
            document.getElementById("admin-welcome").innerText="Hocam Ho≈ügeldiniz";
            dersleriDoldur();
            ekranDegistir("course-select-screen");
        } else {
            let db=JSON.parse(localStorage.getItem("studentsDB"));
            let ogr=db.find(s=>s.no==u);
            if(ogr && ogr.pass==p){
                localStorage.setItem("aktifOgrenciNo",ogr.no);
                document.getElementById("student-welcome").innerText="Merhaba, "+ogr.name;
                ekranDegistir("student-screen");
            } else document.getElementById("login-error").style.display="block";
        }
    }

    // --- DERS ƒ∞≈ûLEMLERƒ∞ ---
    function dersleriDoldur(){
        const s=document.getElementById("ders-secimi"); s.innerHTML="";
        JSON.parse(localStorage.getItem("coursesDB")).forEach(d=>{
            let o=document.createElement("option"); o.value=d; o.innerText=d; s.appendChild(o);
        });
    }
    function yeniDersEkle(){
        let n=document.getElementById("yeni-ders").value.trim();
        if(!n) return;
        let db=JSON.parse(localStorage.getItem("coursesDB"));
        if(!db.includes(n)) { db.push(n); localStorage.setItem("coursesDB",JSON.stringify(db)); dersleriDoldur(); }
        document.getElementById("yeni-ders").value="";
    }
    function dersiYonet(){
        secilenDers=document.getElementById("ders-secimi").value;
        if(!secilenDers) return;
        document.getElementById("panel-baslik").innerText=secilenDers;
        ekranDegistir("teacher-panel");
    }

    // --- HOCA: MANUEL EKLEME (≈ûƒ∞FRE = SON 6 HANE) ---
    function manuelEkle(){
        let ad=document.getElementById("man-name").value, no=document.getElementById("man-no").value;
        if(!ad || !no) return;
        let db=JSON.parse(localStorage.getItem("studentsDB"));
        if(!db.some(s=>s.no==no)){
            // ≈ûƒ∞FRE MANTIƒûI: Numaranƒ±n son 6 hanesi, yoksa tamamƒ±
            let pass = no.length>=6 ? no.slice(-6) : no; 
            db.push({no:no, name:ad, pass:pass});
            localStorage.setItem("studentsDB",JSON.stringify(db));
            alert(ad + " eklendi.\n≈ûifresi: " + pass + " (No'nun son 6 hanesi)");
        } else { alert("Bu numara zaten kayƒ±tlƒ±!"); }
        document.getElementById("man-name").value=""; document.getElementById("man-no").value="";
    }

    // --- PDF Y√úKLEME (≈ûƒ∞FRE = SON 6 HANE) ---
    async function pdfYukle(input){
        let file=input.files[0]; if(!file) return;
        document.getElementById("pdf-status").innerText="Taranƒ±yor...";
        let reader=new FileReader();
        reader.onload=async function(e){
            try{
                let pdf=await pdfjsLib.getDocument(new Uint8Array(e.target.result)).promise;
                let txt="";
                for(let i=1;i<=pdf.numPages;i++) txt+=(await (await pdf.getPage(i)).getTextContent()).items.map(s=>s.str).join(" ");
                let nums=txt.match(/\b\d{9,11}\b/g);
                if(nums){
                    let db=JSON.parse(localStorage.getItem("studentsDB")), c=0;
                    nums.forEach(n=>{
                        if(!db.some(s=>s.no==n)){
                            // PDF ƒ∞√áƒ∞N ≈ûƒ∞FRE MANTIƒûI
                            let pass = n.length>=6 ? n.slice(-6) : n; 
                            db.push({no:n, name:"√ñƒürenci "+n, pass:pass}); c++;
                        }
                    });
                    localStorage.setItem("studentsDB",JSON.stringify(db));
                    document.getElementById("pdf-status").innerText=`‚úÖ ${c} Ki≈üi Eklendi (≈ûifreler son 6 hane)`;
                } else document.getElementById("pdf-status").innerText="No bulunamadƒ±.";
            }catch(err){console.log(err);}
        };
        reader.readAsArrayBuffer(file);
    }

    // --- QR & YOKLAMA Y√ñNETƒ∞Mƒ∞ ---
    function qrBaslat(){
        ekranDegistir("qr-screen");
        if(!qrcodeObj) qrcodeObj=new QRCode(document.getElementById("qrcode"),{width:200,height:200});
        yoklamaBitis=Date.now()+5*60*1000; // 5 Dakika
        updateQR();
        qrInterval=setInterval(updateQR,3000);
        timerInterval=setInterval(()=>{
            let k=yoklamaBitis-Date.now();
            if(k<=0) yoklamayiBitir();
            let dk=Math.floor(k/60000), sn=Math.floor((k%60000)/1000);
            document.getElementById("countdown").innerText=`${dk}:${sn<10?'0'+sn:sn}`;
        },1000);
    }
    function updateQR(){ qrcodeObj.clear(); qrcodeObj.makeCode("YOKLAMA|"+secilenDers+"|"+Date.now()); }
    function yoklamayiBitir(){ clearInterval(qrInterval); clearInterval(timerInterval); ekranDegistir("teacher-panel"); }

    // --- √ñƒûRENCƒ∞ OKUTMA (ANINDA KAYIT) ---
    function kamerayiAc(){
        document.getElementById("reader").style.display="block";
        document.getElementById("btn-camera").style.display="none";
        scanner=new Html5QrcodeScanner("reader",{fps:10,qrbox:250});
        scanner.render(txt=>{
            if(txt.startsWith("YOKLAMA|")){
                let p=txt.split("|"), ders=p[1], tarih=new Date().toLocaleDateString("tr-TR");
                
                // Anƒ±nda DB'ye Yazma (G√ºvenli)
                let db=JSON.parse(localStorage.getItem("attendanceDB"));
                if(!db[ders]) db[ders]={}; if(!db[ders][tarih]) db[ders][tarih]=[];
                
                let no=localStorage.getItem("aktifOgrenciNo");
                if(!db[ders][tarih].includes(no)){
                    db[ders][tarih].push(no);
                    localStorage.setItem("attendanceDB",JSON.stringify(db)); // Kaydet
                    document.getElementById("result-area").innerHTML="<span style='color:green'>‚úÖ VAR YAZILDIN (Kaydedildi)</span>";
                } else document.getElementById("result-area").innerHTML="<span>‚ÑπÔ∏è Zaten listedesin</span>";
                
                scanner.clear(); // Okuma bitince kamerayƒ± kapat
            }
        });
    }

    // --- Lƒ∞STE & GE√áMƒ∞≈û ---
    function gecmisiGoster(){
        ekranDegistir("history-screen");
        let t=document.getElementById("history-table"); t.innerHTML="";
        let db=JSON.parse(localStorage.getItem("attendanceDB"))[secilenDers]||{};
        let st=JSON.parse(localStorage.getItem("studentsDB"));
        let dates=Object.keys(db);

        let h="<tr><th>No</th><th>Devam %</th>"; dates.forEach(d=>h+=`<th>${d}</th>`); h+="</tr>";
        st.forEach(s=>{
            let g=0; dates.forEach(d=>{if(db[d].includes(s.no))g++});
            let y=dates.length?Math.round(g/dates.length*100):0;
            h+=`<tr><td>${s.no}<br>${s.name}</td><td style="color:${y<70?'red':'green'}">%${y}</td>`;
            dates.forEach(d=>{
                let v=db[d].includes(s.no);
                h+=`<td onclick="durumDegistir('${d}','${s.no}')" class="${v?'var':'yok'}">${v?'VAR':'YOK'}</td>`;
            });
            h+="</tr>";
        });
        t.innerHTML=h;
    }

    function durumDegistir(d,n){
        let db=JSON.parse(localStorage.getItem("attendanceDB"));
        let l=db[secilenDers][d], i=l.indexOf(n);
        if(i>-1) l.splice(i,1); else l.push(n);
        localStorage.setItem("attendanceDB",JSON.stringify(db));
        gecmisiGoster();
    }
    
    function cikisYap(){
        if(qrInterval) clearInterval(qrInterval); if(timerInterval) clearInterval(timerInterval);
        ekranDegistir("login-screen");
        document.getElementById("login-no").value=""; document.getElementById("login-password").value="";
    }
</script>
</body>
</html>
