<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>IÄŸdÄ±r Ãœniversitesi - Yoklama Sistemi</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script src="https://unpkg.com/html5-qrcode"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
    body{font-family:'Segoe UI',sans-serif;background:#f4f7f6;display:flex;justify-content:center;align-items:center;min-height:100vh;margin:0}
    .card{background:#fff;padding:2rem;border-radius:12px;width:600px;max-width:98%;box-shadow:0 8px 30px rgba(0,0,0,0.08);display:none;text-align:center;animation:fadeIn 0.3s}
    @keyframes fadeIn {from{opacity:0;transform:translateY(-10px)} to{opacity:1;transform:translateY(0)}}
    #login-screen{display:block}
    h2{color:#2c3e50;margin-bottom:20px}
    button,input,select{width:100%;padding:12px;margin:8px 0;border:1px solid #dee2e6;border-radius:6px;box-sizing:border-box;font-size:14px}
    button{cursor:pointer;font-weight:600;transition:0.2s}
    .btn-primary{background:#007bff;color:#fff;border:none}
    .btn-secondary{background:#fff;color:#007bff;border:1px solid #007bff}
    .btn-danger{background:#dc3545;color:#fff;border:none}
    .table-container{overflow-x:auto;margin-top:15px;border:1px solid #ccc}
    table{width:100%;border-collapse:collapse;font-size:13px;background:white}
    th,td{border:1px solid #999;padding:12px;text-align:center;vertical-align:middle}
    th{background:#e9ecef;color:#333;font-weight:bold}
    .var { background: #d1e7dd !important; color: #0f5132 !important; font-weight: bold; cursor: pointer; }
    .yok { background: #f8d7da !important; color: #842029 !important; font-weight: bold; cursor: pointer; }
    .action-btn{background:none;border:none;cursor:pointer;font-size:18px;padding:2px 8px}
    .upload-box{border:2px dashed #007bff;padding:20px;margin:15px 0;background:#fcfdff;cursor:pointer;color:#444}
    .date-note{font-size:10px; display:block; color:#666; margin-top:4px;}
    .info-text{color:#555;font-size:14px;margin:15px 0;}
    #qr-container{margin:20px auto; width:200px; height:200px;}
</style>
</head>
<body>

    <!-- GiriÅŸ EkranÄ± -->
    <div id="login-screen" class="card">
        <h2>Yoklama Sistemi</h2>
        <p class="info-text">
            <b>Ã–ÄŸrenci GiriÅŸi:</b><br>
            KullanÄ±cÄ± AdÄ±: Ã–ÄŸrenci NumaranÄ±z (10 haneli, Ã¶r: 2400000000)<br>
            Åifre: NumaranÄ±zÄ±n son 6 hanesi (Ã¶r: 000000)
        </p>
        <input type="text" id="username" placeholder="Ã–ÄŸrenci No (10 hane)" maxlength="10">
        <input type="password" id="password" placeholder="Åifre (Son 6 hane)">
        <button class="btn-primary" onclick="ogrenciGiris()">Ã–ÄŸrenci GiriÅŸi</button>
        <hr style="margin:20px 0;">
        <button class="btn-primary" onclick="ogretmenGiris()">Ã–ÄŸretmen Paneli</button>
    </div>

    <!-- Ã–ÄŸretmen Paneli -->
    <div id="teacher-panel" class="card">
        <h2>Ã–ÄŸretmen Paneli</h2>
        <select id="ders-secim" onchange="dersSec()">
            <option value="">Ders SeÃ§in</option>
        </select>
        <button class="btn-primary" onclick="yeniDersEkle()">Yeni Ders Ekle</button>
        <button class="btn-primary" onclick="ogrenciEkle()">Ã–ÄŸrenci Ekle</button>
        <button class="btn-primary" onclick="yoklamaAl()">Yoklama Al (QR OluÅŸtur)</button>
        <button class="btn-primary" onclick="gecmisiGoster()">Yoklama GeÃ§miÅŸi</button>
        <button class="btn-secondary" onclick="ekranDegistir('login-screen')">Ã‡Ä±kÄ±ÅŸ Yap</button>
    </div>

    <!-- Yeni Ders Ekle -->
    <div id="new-lesson-screen" class="card">
        <h2>Yeni Ders Ekle</h2>
        <input type="text" id="new-lesson-name" placeholder="Ders AdÄ± (Ã¶r: MAT101)">
        <button class="btn-primary" onclick="dersKaydet()">Kaydet</button>
        <button class="btn-secondary" onclick="ekranDegistir('teacher-panel')">Geri</button>
    </div>

    <!-- Ã–ÄŸrenci Ekle -->
    <div id="add-student-screen" class="card">
        <h2>Ã–ÄŸrenci Ekle</h2>
        <div class="upload-box" onclick="dosyaSec()">Excel DosyasÄ± YÃ¼kle (Toplu)</div>
        <input type="file" id="student-file" style="display:none" accept=".xlsx" onchange="ogrencileriYukle()">
        <input type="text" id="student-no" placeholder="Ã–ÄŸrenci No (10 hane)">
        <input type="text" id="student-name" placeholder="Ä°sim Soyisim">
        <button class="btn-primary" onclick="tekOgrenciEkle()" id="add-btn">Ã–ÄŸrenciyi Ekle ve Listeye Ekle</button>
        <button class="btn-secondary" onclick="ekranDegistir('teacher-panel')">Geri</button>
    </div>

    <!-- Ã–ÄŸretmen QR OluÅŸurma EkranÄ± -->
    <div id="qr-generate-screen" class="card">
        <h2 id="qr-title"></h2>
        <p>Ã–ÄŸrenciler bu QR'Ä± okutarak yoklama verebilir. (Her 4 saniyede yenilenir)</p>
        <div id="qr-container"></div>
        <button class="btn-danger" onclick="yoklamayiBitir()">YoklamayÄ± Bitir</button>
        <button class="btn-secondary" onclick="ekranDegistir('teacher-panel')">Geri</button>
    </div>

    <!-- Ã–ÄŸrenci QR Okutma EkranÄ± -->
    <div id="student-scan-screen" class="card">
        <h2>Yoklama Ä°Ã§in QR Okut</h2>
        <div id="qr-reader" style="width:100%; height:300px; margin-bottom:20px;"></div>
        <p id="scan-status" style="color:#28a745; font-weight:bold;"></p>
        <button class="btn-secondary" onclick="ekranDegistir('login-screen')">Ã‡Ä±kÄ±ÅŸ Yap</button>
    </div>

    <!-- Yoklama GeÃ§miÅŸi -->
    <div id="history-screen" class="card" style="width:98%; max-width:1400px">
        <h2 id="history-title"></h2>
        <div style="display:flex; gap:10px; margin-bottom:15px; justify-content:center; flex-wrap:wrap">
            <button class="btn-primary" style="background:#198754; border:none" onclick="indirPDF()">PDF Ä°ndir</button>
            <button class="btn-primary" style="background:#ffc107; color:black; border:none" onclick="indirExcel()">Excel Ä°ndir</button>
        </div>
        <div class="table-container">
            <table id="history-table"></table>
        </div>
        <button class="btn-secondary" onclick="ekranDegistir('teacher-panel')">Geri DÃ¶n</button>
    </div>

<script>
    let secilenDers = "";
    let html5QrCode;
    let bugunTarih = new Date().toLocaleDateString('tr-TR', {day:'2-digit', month:'2-digit', year:'numeric'}).replace(/\./g, '-');
    let qrTimer;
    let qrCounter = 0;

    function veritabaniGetir(key) {
        return JSON.parse(localStorage.getItem(key)) || {};
    }

    function veritabaniKaydet(key, data) {
        localStorage.setItem(key, JSON.stringify(data));
    }

    function ekranDegistir(ekranId) {
        document.querySelectorAll('.card').forEach(card => card.style.display = 'none');
        const target = document.getElementById(ekranId);
        if (target) target.style.display = 'block';
    }

    // Ã–ÄŸrenci GiriÅŸi
    function ogrenciGiris() {
        let username = document.getElementById('username').value.trim();
        let password = document.getElementById('password').value.trim();

        if (username.length !== 10 || isNaN(username)) return alert('Ã–ÄŸrenci no 10 haneli olmalÄ±!');
        if (password !== username.slice(-6)) return alert('Åifre numaranÄ±zÄ±n son 6 hanesi olmalÄ±!');

        ekranDegistir('student-scan-screen');
        qrOkutBaslat(username);
    }

    function qrOkutBaslat(ogrNo) {
        html5QrCode = new Html5Qrcode("qr-reader");
        html5QrCode.start(
            { facingMode: "environment" },
            { fps: 5, qrbox: 250 },
            (decodedText) => {
                let [ders, tarih, counter] = decodedText.split('-');
                if (ders === secilenDers && tarih === bugunTarih) {
                    let enrollmentsDB = veritabaniGetir('enrollmentsDB');
                    if (enrollmentsDB[ders]?.includes(ogrNo)) {
                        let attendanceDB = veritabaniGetir('attendanceDB');
                        if (!attendanceDB[ders]) attendanceDB[ders] = {};
                        if (!attendanceDB[ders][tarih]) attendanceDB[ders][tarih] = [];
                        if (!attendanceDB[ders][tarih].includes(ogrNo)) {
                            attendanceDB[ders][tarih].push(ogrNo);
                            veritabaniKaydet('attendanceDB', attendanceDB);
                            document.getElementById('scan-status').innerText = 'Yoklama verildi! TeÅŸekkÃ¼rler.';
                        } else {
                            document.getElementById('scan-status').innerText = 'Zaten yoklama verdiniz.';
                        }
                    } else {
                        document.getElementById('scan-status').innerText = 'Bu derse kayÄ±tlÄ± deÄŸilsiniz.';
                    }
                } else {
                    document.getElementById('scan-status').innerText = 'GeÃ§ersiz QR kodu.';
                }
            },
            () => {}
        ).catch(err => console.log(err));
    }

    // Ã–ÄŸretmen GiriÅŸi
    function ogretmenGiris() {
        let sifre = prompt("Ã–ÄŸretmen ÅŸifresini girin:");
        if (sifre === "1234") {
            ekranDegistir('teacher-panel');
            dersleriYukle();
        } else {
            alert('YanlÄ±ÅŸ ÅŸifre!');
        }
    }

    function dersSec() {
        secilenDers = document.getElementById('ders-secim').value;
    }

    function dersleriYukle() {
        let lessonsDB = veritabaniGetir('lessonsDB');
        let select = document.getElementById('ders-secim');
        select.innerHTML = '<option value="">Ders SeÃ§in</option>';
        Object.keys(lessonsDB).forEach(ders => {
            select.innerHTML += `<option value="${ders}">${ders}</option>`;
        });
    }

    function yeniDersEkle() {
        ekranDegistir('new-lesson-screen');
    }

    function dersKaydet() {
        let name = document.getElementById('new-lesson-name').value.trim();
        if (!name) return alert('Ders adÄ± girin!');
        let lessonsDB = veritabaniGetir('lessonsDB');
        lessonsDB[name] = true;
        veritabaniKaydet('lessonsDB', lessonsDB);
        dersleriYukle();
        ekranDegistir('teacher-panel');
    }

    function ogrenciEkle() {
        if (!secilenDers) return alert('Ã–nce ders seÃ§in!');
        ekranDegistir('add-student-screen');
    }

    function dosyaSec() {
        document.getElementById('student-file').click();
    }

    function ogrencileriYukle() {
        let file = document.getElementById('student-file').files[0];
        if (!file) return alert('Dosya seÃ§in!');
        let reader = new FileReader();
        reader.onload = function(e) {
            let data = new Uint8Array(e.target.result);
            let workbook = XLSX.read(data, {type: 'array'});
            let sheet = workbook.Sheets[workbook.SheetNames[0]];
            let rows = XLSX.utils.sheet_to_json(sheet, {header:1});
            let studentsDB = veritabaniGetir('studentsDB');
            if (!studentsDB) studentsDB = {};
            let enrollmentsDB = veritabaniGetir('enrollmentsDB');
            if (!enrollmentsDB[secilenDers]) enrollmentsDB[secilenDers] = [];
            let eklenen = 0;
            rows.forEach(row => {
                if (row[0] && row[1]) {
                    let no = row[0].toString().trim();
                    studentsDB[no] = {name: row[1]};
                    if (!enrollmentsDB[secilenDers].includes(no)) {
                        enrollmentsDB[secilenDers].push(no);
                        eklenen++;
                    }
                }
            });
            veritabaniKaydet('studentsDB', studentsDB);
            veritabaniKaydet('enrollmentsDB', enrollmentsDB);
            alert(`Toplu ekleme baÅŸarÄ±lÄ±! ${eklenen} Ã¶ÄŸrenci eklendi.`);
            ekranDegistir('teacher-panel');
        };
        reader.readAsArrayBuffer(file);
    }

    function tekOgrenciEkle() {
        document.getElementById('add-btn').innerText = "Ekleniyor...";
        let no = document.getElementById('student-no').value.trim();
        let name = document.getElementById('student-name').value.trim();
        if (no.length !== 10 || isNaN(no)) {
            document.getElementById('add-btn').innerText = "Ã–ÄŸrenciyi Ekle ve Listeye Ekle";
            return alert('Ã–ÄŸrenci no 10 haneli olmalÄ±!');
        }
        if (!name) {
            document.getElementById('add-btn').innerText = "Ã–ÄŸrenciyi Ekle ve Listeye Ekle";
            return alert('Ä°sim girin!');
        }
        let studentsDB = veritabaniGetir('studentsDB');
        if (!studentsDB) studentsDB = {};
        let enrollmentsDB = veritabaniGetir('enrollmentsDB');
        if (!enrollmentsDB[secilenDers]) enrollmentsDB[secilenDers] = [];
        studentsDB[no] = {name: name};
        if (!enrollmentsDB[secilenDers].includes(no)) {
            enrollmentsDB[secilenDers].push(no);
        }
        veritabaniKaydet('studentsDB', studentsDB);
        veritabaniKaydet('enrollmentsDB', enrollmentsDB);
        document.getElementById('add-btn').innerText = "Ã–ÄŸrenciyi Ekle ve Listeye Ekle";
        alert('BaÅŸarÄ±lÄ± ÅŸekilde Ã¶ÄŸrenci eklendi!');
        ekranDegistir('teacher-panel');
    }

    // Yoklama Al (QR OluÅŸtur - Her 4 saniyede yenile)
    function yoklamaAl() {
        if (!secilenDers) return alert('Ders seÃ§in!');
        ekranDegistir('qr-generate-screen');
        document.getElementById('qr-title').innerText = secilenDers + ' - Yoklama QR Kodu';
        qrOlusturVeYenile();
        qrTimer = setInterval(qrOlusturVeYenile, 4000);
    }

    function qrOlusturVeYenile() {
        qrCounter++;
        let qrData = `${secilenDers}-${bugunTarih}-${qrCounter}`;
        document.getElementById('qr-container').innerHTML = "";
        new QRCode(document.getElementById('qr-container'), {
            text: qrData,
            width: 200,
            height: 200
        });
    }

    function yoklamayiBitir() {
        clearInterval(qrTimer);
        alert('Yoklama kaydedildi!');
        gecmisiGoster();
    }

    function gecmisiGoster() {
        if (!secilenDers) return alert('Ders seÃ§in!');
        ekranDegistir('history-screen');
        document.getElementById('history-title').innerText = secilenDers + ' - Yoklama Tablosu';
        tabloyuCiz();
    }

    function tabloyuCiz() {
        let table = document.getElementById('history-table');
        table.innerHTML = '';
        let eDB = (veritabaniGetir('enrollmentsDB')[secilenDers] || []);
        let aDB = (veritabaniGetir('attendanceDB')[secilenDers] || {});
        let sDB = veritabaniGetir('studentsDB');
        let dates = Object.keys(aDB).sort();
        if (eDB.length === 0) {
            table.innerHTML = `<tr><td colspan="10" style="padding:50px;color:#888">Bu derse Ã¶ÄŸrenci eklenmemiÅŸ.</td></tr>`;
            return;
        }
        if (dates.length === 0) {
            table.innerHTML = `<tr><td colspan="10" style="padding:50px;color:#888">HenÃ¼z yoklama alÄ±nmamÄ±ÅŸ.</td></tr>`;
            return;
        }
        let html = `<thead><tr><th>Ã–ÄŸrenci AdÄ±</th><th>Ã–ÄŸrenci No</th><th>Ä°ÅŸlem</th>`;
        dates.forEach(d => html += `<th>${d}<br><small>GÃ¼n-Ay-YÄ±l</small></th>`);
        html += `</tr></thead><tbody>`;
        eDB.forEach(no => {
            let ogr = sDB[no] || {name: 'Ä°sim Yok'};
            html += `<tr><td style="text-align:left;padding-left:15px;">${ogr.name}</td><td><b>${no}</b></td>`;
            html += `<td><button class="action-btn" onclick="isimDuzenle('${no}')">âœï¸</button> <button class="action-btn" onclick="ogrenciSil('${no}')">ğŸ—‘ï¸</button></td>`;
            dates.forEach(d => {
                let varmi = aDB[d]?.includes(no) || false;
                html += `<td class="${varmi ? 'var' : 'yok'}" onclick="durumDegistir('${d}','${no}')">${varmi ? 'VAR' : 'YOK'}</td>`;
            });
            html += `</tr>`;
        });
        html += `</tbody>`;
        table.innerHTML = html;
    }

    function isimDuzenle(no) {
        let yeni = prompt('Yeni isim:', (veritabaniGetir('studentsDB')[no]?.name || ''));
        if (yeni) {
            let db = veritabaniGetir('studentsDB');
            db[no] = {name: yeni};
            veritabaniKaydet('studentsDB', db);
            tabloyuCiz();
        }
    }

    function ogrenciSil(no) {
        if (confirm('Ã–ÄŸrenciyi silmek istiyor musunuz?')) {
            let db = veritabaniGetir('enrollmentsDB');
            db[secilenDers] = db[secilenDers].filter(x => x !== no);
            veritabaniKaydet('enrollmentsDB', db);
            tabloyuCiz();
        }
    }

    function durumDegistir(tarih, no) {
        let db = veritabaniGetir('attendanceDB');
        let liste = db[secilenDers][tarih] || [];
        if (liste.includes(no)) {
            liste = liste.filter(x => x !== no);
        } else {
            liste.push(no);
        }
        db[secilenDers][tarih] = liste;
        veritabaniKaydet('attendanceDB', db);
        tabloyuCiz();
    }

    function indirPDF() {
        const { jsPDF } = window.jspdf;
        let doc = new jsPDF();
        doc.autoTable({ html: document.getElementById('history-table') });
        doc.save((secilenDers || 'yoklama') + '.pdf');
    }

    function indirExcel() {
        let wb = XLSX.utils.table_to_book(document.getElementById('history-table'));
        XLSX.writeFile(wb, (secilenDers || 'yoklama') + '.xlsx');
    }
</script>
</body>
</html>
